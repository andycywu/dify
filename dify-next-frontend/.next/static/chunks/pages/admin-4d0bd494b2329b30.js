(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[309],{2418:(e,r,t)=>{"use strict";t.d(r,{A:()=>c}),t(4232);var n=t(7328),s=t.n(n),a=t(7876);let c=function(e){var r=e.title,t=e.children;return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(s(),{children:[(0,a.jsx)("title",{children:r||"TPV OBM測試助理"}),(0,a.jsx)("meta",{name:"description",content:"TPV OBM測試助理"}),(0,a.jsx)("link",{rel:"icon",href:"/favicon.ico"})]}),(0,a.jsx)("div",{className:"flex flex-col bg-gray-100",children:(0,a.jsx)("main",{className:"flex-1 flex flex-col justify-center items-center w-full p-6",children:t})})]})}},4768:(e,r,t)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin",function(){return t(7661)}])},7661:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>h});var n=t(2969),s=t(3857),a=t(3081),c=t.n(a),l=t(4232),i=t(2418),u=t(1040),o=t(1769),d=t(7876);function p(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,n)}return t}function x(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?p(Object(t),!0).forEach(function(r){(0,n.A)(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):p(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}function h(){var e,r,t,n,a,p,h=(0,o.A)(),m=h.user,f=h.loading,b=(0,l.useState)([]),j=b[0],g=b[1],y=(0,l.useState)(!0),v=y[0],N=y[1],w=(0,l.useState)(null),k=w[0],A=w[1],C=(0,l.useState)(null),O=C[0],S=C[1],P=(0,l.useState)({}),_=P[0],E=P[1],D=(0,l.useState)(!1),F=D[0],T=D[1],L=(0,l.useState)({email:"",name:"",password:"",role:"user"}),M=L[0],U=L[1],B=(0,l.useState)(.01),V=B[0],X=B[1],z=(0,l.useState)(!1),I=z[0],J=z[1],K=(0,l.useState)(null),q=K[0],G=K[1];(0,l.useEffect)(function(){if(console.log("[Admin] useEffect",{user:m,authLoading:f}),!f){if(!m||"admin"!==m.role){A("您沒有權限瀏覽此頁面"),N(!1);return}H(),Q()}},[m,f]);var H=(e=(0,s.A)(c().mark(function e(){var r;return c().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return N(!0),A(null),e.prev=2,e.next=5,u.A.get("/api/user");case 5:return r=e.sent,e.next=8,Promise.all(r.data.map(function(){var e=(0,s.A)(c().mark(function e(r){var t;return c().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.A.get("/api/user-token-stats?userId=".concat(r.id));case 2:return t=e.sent,e.abrupt("return",x(x({},r),{},{usages:t.data.dailyUsage}));case 4:case"end":return e.stop()}},e)}));return function(r){return e.apply(this,arguments)}}()));case 8:g(e.sent),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(2),A(e.t0.message||"Failed to fetch users");case 15:return e.prev=15,N(!1),e.finish(15);case 18:case"end":return e.stop()}},e,null,[[2,12,15,18]])})),function(){return e.apply(this,arguments)}),Q=(r=(0,s.A)(c().mark(function e(){return c().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return J(!0),G(null),e.prev=2,e.next=5,u.A.get("/api/billing-rate");case 5:X(e.sent.data.rate),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),G(e.t0.message||"Failed to fetch rate");case 12:return e.prev=12,J(!1),e.finish(12);case 15:case"end":return e.stop()}},e,null,[[2,9,12,15]])})),function(){return r.apply(this,arguments)}),R=function(e){S(e.id),E(x({},e))},W=(t=(0,s.A)(c().mark(function e(){return c().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.A.put("/api/user/".concat(O),_);case 2:S(null),H();case 4:case"end":return e.stop()}},e)})),function(){return t.apply(this,arguments)}),Y=(n=(0,s.A)(c().mark(function e(r){return c().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(window.confirm("確定要刪除這個用戶嗎？")){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,u.A.delete("/api/user/".concat(r));case 4:H();case 5:case"end":return e.stop()}},e)})),function(e){return n.apply(this,arguments)}),Z=(a=(0,s.A)(c().mark(function e(){return c().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.A.post("/api/user",M);case 2:T(!1),U({email:"",name:"",password:"",role:"user"}),H();case 5:case"end":return e.stop()}},e)})),function(){return a.apply(this,arguments)}),$=(p=(0,s.A)(c().mark(function e(){return c().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return J(!0),G(null),e.prev=2,e.next=5,u.A.post("/api/billing-rate",{rate:V});case 5:H(),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(2),G(e.t0.message||"Failed to save rate");case 11:return e.prev=11,J(!1),e.finish(11);case 14:case"end":return e.stop()}},e,null,[[2,8,11,14]])})),function(){return p.apply(this,arguments)});return(0,d.jsx)(i.A,{title:"管理員介面",children:(0,d.jsx)("div",{className:"w-full max-w-5xl mx-auto",children:(0,d.jsxs)("div",{className:"bg-white rounded-lg shadow-lg p-8",children:[(0,d.jsx)("h2",{className:"text-2xl font-bold mb-4 text-center",children:"用戶管理"}),(0,d.jsxs)("pre",{className:"text-xs bg-gray-100 p-2 mb-2 rounded text-gray-600",children:["user: ",JSON.stringify(m),"\\nauthLoading: ",String(f),"\\nerror: ",k]}),f?(0,d.jsx)("div",{className:"text-center",children:"載入中..."}):k?(0,d.jsx)("div",{className:"text-red-500 text-center",children:k}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)("div",{className:"mb-4 flex flex-col md:flex-row gap-4 items-center justify-between",children:[(0,d.jsx)("div",{children:(0,d.jsx)("button",{className:"bg-blue-600 text-white px-4 py-2 rounded",onClick:function(){return T(function(e){return!e})},children:"新增用戶"})}),(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)("span",{children:"Token 計費費率 (USD/1K Token):"}),(0,d.jsx)("input",{type:"number",step:"0.0001",value:V,onChange:function(e){return X(Number(e.target.value))},className:"border rounded px-2 py-1 w-28"}),(0,d.jsx)("button",{className:"bg-green-600 text-white px-3 py-1 rounded",onClick:$,disabled:I,children:"儲存"}),q&&(0,d.jsx)("span",{className:"text-red-500 ml-2",children:q})]})]}),F&&(0,d.jsxs)("div",{className:"mb-6 p-4 border rounded bg-gray-50",children:[(0,d.jsx)("h3",{className:"font-semibold mb-2",children:"新增用戶"}),(0,d.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,d.jsx)("input",{className:"border rounded px-2 py-1",placeholder:"Email",value:M.email,onChange:function(e){return U(function(r){return x(x({},r),{},{email:e.target.value})})}}),(0,d.jsx)("input",{className:"border rounded px-2 py-1",placeholder:"姓名",value:M.name,onChange:function(e){return U(function(r){return x(x({},r),{},{name:e.target.value})})}}),(0,d.jsx)("input",{className:"border rounded px-2 py-1",placeholder:"密碼",type:"password",value:M.password,onChange:function(e){return U(function(r){return x(x({},r),{},{password:e.target.value})})}}),(0,d.jsxs)("select",{className:"border rounded px-2 py-1",value:M.role,onChange:function(e){return U(function(r){return x(x({},r),{},{role:e.target.value})})},children:[(0,d.jsx)("option",{value:"user",children:"user"}),(0,d.jsx)("option",{value:"admin",children:"admin"})]}),(0,d.jsxs)("div",{className:"flex gap-2 mt-2",children:[(0,d.jsx)("button",{className:"bg-blue-600 text-white px-4 py-2 rounded",onClick:Z,children:"建立"}),(0,d.jsx)("button",{className:"bg-gray-300 px-4 py-2 rounded",onClick:function(){return T(!1)},children:"取消"})]})]})]}),v?(0,d.jsx)("div",{className:"text-center",children:"載入中..."}):k?(0,d.jsx)("div",{className:"text-red-500 text-center",children:k}):(0,d.jsxs)("table",{className:"min-w-full border text-sm",children:[(0,d.jsx)("thead",{children:(0,d.jsxs)("tr",{className:"bg-gray-100",children:[(0,d.jsx)("th",{className:"px-4 py-2 border",children:"姓名"}),(0,d.jsx)("th",{className:"px-4 py-2 border",children:"Email"}),(0,d.jsx)("th",{className:"px-4 py-2 border",children:"角色"}),(0,d.jsx)("th",{className:"px-4 py-2 border",children:"建立時間"}),(0,d.jsx)("th",{className:"px-4 py-2 border",children:"總用量"}),(0,d.jsx)("th",{className:"px-4 py-2 border",children:"月平均用量"}),(0,d.jsx)("th",{className:"px-4 py-2 border",children:"總費用"}),(0,d.jsx)("th",{className:"px-4 py-2 border",children:"月平均費用"}),(0,d.jsx)("th",{className:"px-4 py-2 border",children:"操作"})]})}),(0,d.jsx)("tbody",{children:j.map(function(e){var r=function(e){if(!e||0===e.length)return{total:0,avg:0,cost:0,avgCost:0};var r=e.reduce(function(e,r){return e+(r.tokenUsage||0)},0),t=e.reduce(function(e,r){return e+(r.billing||0)},0),n=e.reduce(function(e,r){var t;return e.add(null==(t=r.date)?void 0:t.slice(0,7))},new Set).size||1;return{total:r,avg:Math.round(r/n),cost:Number(t.toFixed(4)),avgCost:Number((t/n).toFixed(4))}}(e.usages);return O===e.id?(0,d.jsxs)("tr",{className:"text-center bg-yellow-50",children:[(0,d.jsx)("td",{className:"border px-4 py-2",children:(0,d.jsx)("input",{className:"border rounded px-2 py-1",value:_.name,onChange:function(e){return E(function(r){return x(x({},r),{},{name:e.target.value})})}})}),(0,d.jsx)("td",{className:"border px-4 py-2",children:(0,d.jsx)("input",{className:"border rounded px-2 py-1",value:_.email,onChange:function(e){return E(function(r){return x(x({},r),{},{email:e.target.value})})}})}),(0,d.jsx)("td",{className:"border px-4 py-2",children:(0,d.jsxs)("select",{className:"border rounded px-2 py-1",value:_.role,onChange:function(e){return E(function(r){return x(x({},r),{},{role:e.target.value})})},children:[(0,d.jsx)("option",{value:"user",children:"user"}),(0,d.jsx)("option",{value:"admin",children:"admin"})]})}),(0,d.jsx)("td",{className:"border px-4 py-2",children:e.createdAt?new Date(e.createdAt).toLocaleString():""}),(0,d.jsx)("td",{className:"border px-4 py-2",children:r.total}),(0,d.jsx)("td",{className:"border px-4 py-2",children:r.avg}),(0,d.jsx)("td",{className:"border px-4 py-2",children:r.cost}),(0,d.jsx)("td",{className:"border px-4 py-2",children:r.avgCost}),(0,d.jsxs)("td",{className:"border px-4 py-2 flex gap-2 justify-center",children:[(0,d.jsx)("button",{className:"bg-green-600 text-white px-2 py-1 rounded",onClick:W,children:"儲存"}),(0,d.jsx)("button",{className:"bg-gray-300 px-2 py-1 rounded",onClick:function(){return S(null)},children:"取消"})]})]},e.id):(0,d.jsxs)("tr",{className:"text-center",children:[(0,d.jsx)("td",{className:"border px-4 py-2",children:e.name||(0,d.jsx)("span",{className:"italic text-gray-400",children:"未設定"})}),(0,d.jsx)("td",{className:"border px-4 py-2",children:e.email}),(0,d.jsx)("td",{className:"border px-4 py-2",children:e.role}),(0,d.jsx)("td",{className:"border px-4 py-2",children:e.createdAt?new Date(e.createdAt).toLocaleString():""}),(0,d.jsx)("td",{className:"border px-4 py-2",children:r.total}),(0,d.jsx)("td",{className:"border px-4 py-2",children:r.avg}),(0,d.jsx)("td",{className:"border px-4 py-2",children:r.cost}),(0,d.jsx)("td",{className:"border px-4 py-2",children:r.avgCost}),(0,d.jsxs)("td",{className:"border px-4 py-2 flex gap-2 justify-center",children:[(0,d.jsx)("button",{className:"bg-yellow-500 text-white px-2 py-1 rounded",onClick:function(){return R(e)},children:"編輯"}),(0,d.jsx)("button",{className:"bg-red-600 text-white px-2 py-1 rounded",onClick:function(){return Y(e.id)},children:"刪除"})]})]},e.id)})})]})]})]})})})}}},e=>{var r=r=>e(e.s=r);e.O(0,[149,636,593,792],()=>r(4768)),_N_E=e.O()}]);